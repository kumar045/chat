
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Based Chat Application</title>
    <style>

     body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 20px;
}

#app {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

button {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
}

button:hover {
    background-color: #0056b3;
}

#devices-container {
    margin-bottom: 20px;
}

#character-selection {
    margin-top: 20px;
}

.custom-radio {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    cursor: pointer;
}

.custom-radio input[type="radio"] {
    display: none;
}

.custom-radio .radio-btn {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #007bff;
    margin-right: 10px;
    position: relative;
}

.custom-radio .radio-btn img {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    height: 90%;
    object-fit: cover;
    border-radius: 50%;
}

.custom-radio input[type="radio"]:checked + .radio-btn img {
    display: block;
}

#chat-window {
    margin-top: 20px;
    border: 1px solid #ddd;
    padding: 10px;
    background: #fafafa;
    height: 300px;
    overflow-y: auto;
}

    </style>
</head>
<body>
    <div id="app">
        <div id="devices-container">
            <label for="audio-device-selection">Select Microphone:</label>
            <select id="audio-device-selection"></select>
        </div>

        <button id="connect">Connect</button>
        <button id="disconnect" style="display:none;">Disconnect</button>

        <div id="character-selection" style="display:none;"></div>

        <div id="chat-window" style="display:none;"></div>

        <audio id="audio-player" controls style="display:none;"></audio>
    </div>

    <script>
     /**
 * WebSocket Connection
 * The client sends and receives messages through this WebSocket connection.
 */
const connectButton = document.getElementById('connect');
const disconnectButton = document.getElementById('disconnect');
const devicesContainer = document.getElementById('devices-container');
const audioDeviceSelection = document.getElementById('audio-device-selection');
const chatWindow = document.getElementById('chat-window'); // Used for displaying system messages
const audioPlayer = document.getElementById('audio-player'); // Audio player for playing back received audio
let socket;
let clientId = Math.floor(Math.random() * 10000000);
let selectedCharacter = null;

function connectSocket() {
    clientId = Math.floor(Math.random() * 1010000);
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const ws_path = ws_scheme + '://' + 'voicechatflow.in' + `/ws/${clientId}`;
    socket = new WebSocket(ws_path);
    socket.binaryType = 'arraybuffer';

    socket.onopen = (event) => {
        console.log("successfully connected");
        connectMicrophone(audioDeviceSelection.value);
    };

    socket.onmessage = (event) => {
        if (typeof event.data === 'string') {
            if (event.data.startsWith('Select')) {
                createCharacterGroups(event.data);
            }
        } else {  // binary data
            audioQueue.push(event.data);
            if (audioQueue.length === 1) {
                playAudios();
            }
        }
    };

    socket.onerror = (error) => {
        console.log(`WebSocket Error: ${error}`);
    };
  
    socket.onclose = (event) => {
        console.log("Socket closed");
    };
}

connectButton.addEventListener("click", function() {
    connectButton.style.display = "none";
    devicesContainer.style.display = "none";
    connectSocket();
});

disconnectButton.addEventListener("click", function() {
    if (mediaRecorder) {
        mediaRecorder.stop();
    }
    devicesContainer.style.display = "flex";
    connectButton.style.display = "flex";
    disconnectButton.style.display = "none";
    socket.close();
});

/**
 * Devices
 * Get the list of media devices
 */
window.addEventListener("load", function() {
    navigator.mediaDevices.enumerateDevices()
        .then(function(devices) {
            let audioInputDevices = devices.filter(function(device) {
                return device.kind === 'audioinput';
            });

            if (audioInputDevices.length === 0) {
                console.log('No audio input devices found');
                return;
            }

            audioInputDevices.forEach(function(device, index) {
                let option = document.createElement('option');
                option.value = device.deviceId;
                option.textContent = device.label || `Microphone ${index + 1}`;
                audioDeviceSelection.appendChild(option);
            });
        })
        .catch(function(err) {
            console.log('An error occurred: ' + err);
        });
});

audioDeviceSelection.addEventListener('change', function(e) {
    connectMicrophone(e.target.value);
});

/**
 * Audio Recording and Transmission
 */
let mediaRecorder;
let chunks = [];

function connectMicrophone(deviceId) {
    navigator.mediaDevices.getUserMedia({
        audio: {
            deviceId: deviceId ? {exact: deviceId} : undefined,
            echoCancellation: true
        }
    }).then(function(stream) {
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = function(e) {
            chunks.push(e.data);
        };

        mediaRecorder.onstop = function(e) {
            let blob = new Blob(chunks, {'type' : 'audio/webm'});
            chunks = [];

            if (socket && socket.readyState === WebSocket.OPEN) {
                console.log("sending audio");
                socket.send(blob);
            }
        }
    })
    .catch(function(err) {
        console.log('An error occurred: ' + err);
    });
}

/**
 * Audio Playback
 */
let audioQueue = [];
let audioContext;
let shouldPlayAudio = false;
let isPlaying = false;

function unlockAudioContext(audioContext) {
    if (audioContext.state === 'suspended') {
        var unlock = function() {
            audioContext.resume().then(function() {
                document.body.removeEventListener('touchstart', unlock);
                document.body.removeEventListener('touchend', unlock);
            });
        };
        document.body.addEventListener('touchstart', unlock, false);
        document.body.addEventListener('touchend', unlock, false);
    }
}

async function playAudios() {
    isPlaying = true;
    while (audioQueue.length > 0) {
        let data = audioQueue[0];
        let blob = new Blob([data], { type: 'audio/mp3' });
        let audioUrl = URL.createObjectURL(blob);
        await playAudio(audioUrl);
        audioQueue.shift();
    }
    isPlaying = false;
}

function playAudio(url) {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        unlockAudioContext(audioContext);
    }
    return new Promise((resolve) => {
        audioPlayer.src = url;
        audioPlayer.play();
        audioPlayer.onended = resolve;
        audioPlayer.play().then(() => {
            audioPlayer.muted = false;
        }).catch(error => alert(`Playback failed because: ${error}`));
    });
}

/**
 * Character Selection
 */
function createCharacterGroups(message) {
    const options = message.split('\n').slice(1);
    const radioButtonDiv = document.getElementById('character-selection'); // Ensure this div exists in your HTML

    options.forEach(option => {
        const match = option.match(/^(\d+)\s-\s(.+)$/);
        if (match) {
            const label = document.createElement('label');
            label.className = 'custom-radio';

            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'radio';
            input.value = match[1];  // The option number is the value

            const span = document.createElement('span');
            span.className = 'radio-btn';

            // Update image path accordingly
            const img = document.createElement('img');
            img.src = '/path/to/character/image';  
            span.appendChild(img);

            label.appendChild(input);
            label.appendChild(span);
            radioButtonDiv.appendChild(label);
        }
    });

    radioButtonDiv.addEventListener('change', (event) => {
        if (event.target.value !== "") {
            selectedCharacter = event.target.value;
            socket.send(selectedCharacter);
        }
    });
}

   </script>

</body>
</html>
